<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>lab_08</title>
	<script src="node_modules/rxjs/bundles/rxjs.umd.min.js"></script>
	<style type="text/css">
		table {
			border-collapse: collapse;
		}

		td, th {
			border: 1px solid #000;
			padding: 0.5em;
		}

		#latestPrice:before {
			content: '$ ';
		}
	</style>
</head>
<body>
	

	<script type="text/javascript">
		const key = prompt("Введіть ключ, ви повинні його знати");

		const getAll = 'https://cloud.iexapis.com/v1/stock/market/batch?symbols=AMZN,ADBE,TSLA,TMUS,QCOM,NFLX,MSFT,INTC&types=quote&filter=symbol,companyName,latestPrice&token=' + key;
		const Update = 'https://cloud.iexapis.com/v1/stock/market/batch?symbols=AMZN,ADBE,TSLA,TMUS,QCOM,NFLX,MSFT,INTC&types=quote&filter=latestPrice&token=' + key;

		let time_update = 0;

		function printTable(element,data) {
			function dce(el) {
				return document.createElement(el);
			}

			let table = dce('table');
			let caption = dce('caption');
			let thead = dce('thead');
			let tbody = dce('tbody');

			let nextUpdate = dce('span');
			nextUpdate.id = 'timeToNextUpdate';

			caption.innerHTML += 'Дані по позиціях на біржі <br>(наступне оновлення через: ';
			caption.appendChild(nextUpdate);
			caption.innerHTML += 'c)';

			table.appendChild(caption);
			
			let tr = dce('tr'); 
			tr.id = 'tableHead';
			for (j in data[Object.keys(data)[0]].quote) {
				let th = dce('th');
				th.textContent = j;
				tr.appendChild(th);
			}
			thead.appendChild(tr);

			table.appendChild(thead);

			for (i in data) {
				let tr = dce('tr'); 
				tr.id = i;
				for (j in data[i].quote) {
					let td = dce('td');
					td.id = j;
					td.textContent = data[i].quote[j];
					tr.appendChild(td);
				}
				tbody.appendChild(tr);
			}

			table.appendChild(tbody);

			element.appendChild(table);
		}

		let xtr = new XMLHttpRequest();

		xtr.open('GET',getAll);

			xtr.onreadystatechange = function() {
				if (xtr.readyState === 4 && xtr.status === 200) {
					printTable(document.getElementsByTagName('body')[0] ,JSON.parse(xtr.responseText));
					time_update = Date.now();
				}
			}

		xtr.send('');

		//=======================================================================

		function updateTable(element,data) {
			for (i in data) {
				for (j in data[i].quote) {
					element.querySelector('#'+i+' > #'+j).textContent = data[i].quote[j];
				}
			}
		}

		let interval$ = rxjs.interval(20000)
		.subscribe( () => {
			xtr.open('GET',Update);

			xtr.onreadystatechange = function() {
				if (xtr.readyState === 4 && xtr.status === 200) {
					updateTable(document.getElementsByTagName('body')[0] ,JSON.parse(xtr.responseText));
					time_update = Date.now();
				}
			}

			xtr.send('');
		});

		//==========================================================================

		let timeToNextUpdate$ = rxjs.interval(100)
		.subscribe( () => {
			if (time_update!=0) {
				document.getElementById('timeToNextUpdate').textContent = Math.round(200 - (Date.now() - time_update) / 100 ) / 10;
			}
		});
		
	</script>
</body>
</html>
